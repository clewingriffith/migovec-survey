<!DOCTYPE html>
<html>
 <head>
	             <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 80% }
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBt22ZSRQ418n6tFZkK0ghcNy0NyZRamdg&sensor=false">
    </script>
    <script type="text/javascript" src="jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="jquery.json-2.4.min.js"></script>
    <script type="text/javascript" src="maplabel-compiled.js"></script>
    <script type="text/javascript" src="markerwithlabel_packed.js"></script>
    <script type="text/javascript">
      var initialize = function() {
        var mapOptions = {
          center: new google.maps.LatLng(0, 0.0),
          zoom: 1,
	  streetViewControl: false,
	  scaleControl:false, //would love to have this, but can't work out how to set the bounds. By default it assumes the size of the earth.
	  mapTypeControlOptions: {
		mapTypeIds: ["Survey"]
	  }
	  
        };
	
		// Bounds for North America
	   var strictBounds = new google.maps.LatLngBounds(
	     new google.maps.LatLng(-20, -180.0), 
	     new google.maps.LatLng(20, 180.90)
	   );

	 
   
	var calculateTileNum = function(coord, zoom) {
	   return coord.y * (1<<zoom) + coord.x;
	};
	
	var drawnSurveyMapTypeOptions = {
		getTileUrl: function(coord, zoom) {
			var normalizedCoord = getNormalizedCoord(coord, zoom);
			if (!normalizedCoord) {
				return null;
			}
			var tileNum = calculateTileNum(coord, zoom);
			return "survey/year/2012/survey/SysMig/zoom/" + zoom + "/t_" + tileNum + ".png";
		},
		tileSize: new google.maps.Size(256,256),
		maxZoom: 5,
		minZoom: 0,
		name: "Drawn Survey"
	};
	
	var drawnSurveyMapType =new google.maps.ImageMapType(drawnSurveyMapTypeOptions);
	
	
        var map = new google.maps.Map(document.getElementById("map-canvas"),
            mapOptions);
	map.mapTypes.set("Survey", drawnSurveyMapType);
	map.setMapTypeId("Survey");
	window.map = map;
	
	addMarkers(map);
	addStoredMarkers();
    
			// bounds of the desired area
		var allowedBounds = new google.maps.LatLngBounds(
		     new google.maps.LatLng(-90,-180), 
		     new google.maps.LatLng(90,180)
		);
		var lastValidCenter = map.getCenter();

		google.maps.event.addListener(map, 'center_changed', function() {
		    if (allowedBounds.contains(map.getCenter())) {
			// still within valid bounds, so save the last valid position
			lastValidCenter = map.getCenter();
			return; 
		    }

		    // not valid anymore => return to last valid position
		    map.panTo(lastValidCenter);
		});
	
	
      };
      
      function addMarkers(map) {        
        var marker = new google.maps.Marker({
            position:new google.maps.LatLng(0, 0.0),
            title:"Requires Enlargement",
            icon:"icons/requires_enlargement_icon.png",
            draggable:true
        });
        marker.setMap(map);
      }
      
      function addLabelToMap(labelData) {
		var storedLabelPosition = labelData.position;
		var storedText = labelData.text_en;
                var latLng = new google.maps.LatLng(storedLabelPosition[0],storedLabelPosition[1]);
		
		var draggableLabel = new MarkerWithLabel({
		icon: {
    path: google.maps.SymbolPath.CIRCLE,
    scale: 0
  },
                        position: latLng,
                        draggable: true,
                        raiseOnDrag: false,
                        map: window.map,
                        labelContent: storedText,
                        labelAnchor: new google.maps.Point(0, 0),
                    });
		    
		    draggableLabel.datakey = labelData.id;
		    //delete draggableLabel.icon;
		    //create closure for label id
		    (function(refLabel) {
			google.maps.event.addListener(draggableLabel, "dragend",
				function (mEvent) { 
					window.alert("Drag End for " + refLabel.datakey +": " + mEvent.latLng.toString()); 
					jQuery.ajax({
						type: "PUT",
						url: "/update/label/" + refLabel.datakey,
						contentType: "application/json",
						data: jQuery.toJSON({
							"id": refLabel.datakey, 
							"text_en":refLabel.labelContent, 
							"position":[refLabel.position.lat(), refLabel.position.lng()]})
					});
				});
		    })(draggableLabel);
      }
      
      function addStoredMarkers() {
     
        jQuery.getJSON( "/labels", 
            function( json ) {
                var labelArr = json.labels;
                for(var l=0; l<labelArr.length; l++) {
		    addLabelToMap(labelArr[l]);
                    //var storedLabelPosition = labelArr[l].position;
                    
                    //var storedText = labelArr[l].text_en;
                    //var latLng = new google.maps.LatLng(storedLabelPosition[0],storedLabelPosition[1]);
                    //window.alert(latLng);
                    
                    //var readOnlyLabel = new MapLabel({
                    //    text: storedText,
                    //    position: latLng,
                    //    map: window.map,
                    //    fontSize: 12
                    //});
                    //window.alert(labelArr[l].id)
                    //~ var draggableLabel = new MarkerWithLabel({
                        //~ position: latLng,
                        //~ draggable: true,
                        //~ raiseOnDrag: false,
                        //~ map: window.map,
                        //~ labelContent: storedText,
                        //~ labelAnchor: new google.maps.Point(0, 0),
                    //~ });
		    //~ draggableLabel.datakey = labelArr[l].id;
		    //~ //create closure for label id
		    //~ (function(refLabel) {
			//~ google.maps.event.addListener(draggableLabel, "dragend",
				//~ function (mEvent) { 
					//~ window.alert("Drag End for " + refLabel.datakey +": " + mEvent.latLng.toString()); 
					//~ jQuery.ajax({
						//~ type: "PUT",
						//~ url: "/update/label/" + refLabel.datakey,
						//~ contentType: "application/json",
						//~ data: jQuery.toJSON({
							//~ "id": refLabel.datakey, 
							//~ "text_en":refLabel.labelContent, 
							//~ "position":[refLabel.position.lat(), refLabel.position.lng()]})
					//~ });
				//~ });
		    //~ })(draggableLabel);
                }

            });
      
      }
      
      // Normalizes the coords that tiles repeat across the x axis (horizontally)
	// like the standard Google map tiles.
	function getNormalizedCoord(coord, zoom) {
		  var y = coord.y;
		  var x = coord.x;

		  // tile range in one direction range is dependent on zoom level
		  // 0 = 1 tile, 1 = 2 tiles, 2 = 4 tiles, 3 = 8 tiles, etc
		  var tileRange = 1 << zoom;

		  // don't repeat across y-axis (vertically)
		  if (y < 0 || y >= tileRange) {
		    return null;
		  }
		  if (x < 0 || x >= tileRange) {
		    return null;
		  }
		  return {
		    x: x,
		    y: y
		  };
	  }
      
    var addMarkers = function() {
    
        var marker = new google.maps.Marker({
            position:new google.maps.LatLng(0, 0.0),
            title:"Requires Enlargement",
            icon:"icons/requires_enlargement_icon.png",
            draggable:true
            });
        marker.setMap(map);
    }      
      
	function addTextLabel() {
		var textInput = document.getElementById('labelInputText');
		
		var labelPosition = new google.maps.LatLng(51.53870, -0.01652);
		
		var newLabelData = {
		"text_en": textInput.value,
		"position": [51.53870, -0.01652]
		}
		
		jQuery.ajax({
			type: "POST",
			url: "/create/label",
			contentType: "application/json",
			data: jQuery.toJSON(newLabelData)
		}).done(function( msg ) {
			alert( "Data Saved: " + msg );
		});
		
		
		addLabelToMap(newLabelData);
		
	}
      
      function addDraggableTextMarker() {
      
      }
      
      
      google.maps.event.addDomListener(window, 'load', initialize);
      
    </script>
 </head>
 <body>
	<div id="edit-palette">
		<h2>Edit palette</h2>
		label <input type="text" class="loginButtons" id="labelInputText" value="New Label" /><br/>
		min zoom level <input type="text" class="loginButtons" value="4" />
		 <button type="button" onclick="addTextLabel();">Add Marker</button>
	</div>
	<div id="map-canvas"/>
 </body>
</html>
